<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Master Pro - ChatGPT Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #212121;
        }
        /* Hide scrollbar while keeping functionality */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .animate-modal {
            animation: zoomIn 0.3s ease-out;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="text-[#ececec] selection:bg-[#404040]">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar (ChatGPT Style) -->
        <aside class="w-64 bg-[#171717] h-full p-3 flex-col hidden md:flex shrink-0">
            <button onclick="resetData()" class="flex items-center gap-3 w-full p-3 border border-white/20 rounded-lg hover:bg-[#2b2b2b] transition mb-4 text-sm font-medium">
                <i data-lucide="plus" class="w-4 h-4"></i> New Calculation
            </button>
            <div class="flex-1 overflow-y-auto space-y-2 scrollbar-hide" id="sidebar-list">
                <div class="text-[10px] text-[#666] font-bold px-3 pt-2 uppercase">Your Categories</div>
                <!-- Dynamically generated sidebar list -->
            </div>
            <div class="border-t border-white/10 pt-3">
                <div class="flex items-center gap-3 p-3 hover:bg-[#2b2b2b] rounded-lg transition text-sm cursor-pointer text-[#b4b4b4]">
                    <i data-lucide="settings" class="w-4 h-4"></i> Settings
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col h-full bg-[#212121] relative">
            <!-- Mobile Header -->
            <header class="h-14 border-b border-white/10 flex items-center justify-between px-4 md:hidden shrink-0">
                <h1 class="font-bold">Grade Master Pro</h1>
                <button onclick="resetData()" class="p-2 text-[#666]"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto">
                <div class="max-w-3xl mx-auto py-12 px-6 space-y-12 pb-32">
                    <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-center">How can I help you calculate your grade?</h1>
                    
                    <div id="categories-container" class="space-y-10">
                        <!-- Categories rendered by JS -->
                    </div>

                    <div class="flex justify-center">
                        <button onclick="addCategory()" class="flex items-center gap-2 bg-[#2f2f2f] border border-white/10 hover:bg-[#3f3f3f] px-6 py-3 rounded-2xl text-sm transition font-medium">
                            <i data-lucide="plus" class="w-4 h-4"></i> Add Custom Category (e.g. Quiz)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Calculation Bar -->
            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-[#212121] via-[#212121] to-transparent">
                <div class="max-w-3xl mx-auto">
                    <button onclick="calculate()" class="w-full bg-white text-black py-4 rounded-2xl font-bold hover:bg-[#ececec] transition flex items-center justify-center gap-3 shadow-2xl">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                        Calculate My Final Grade
                    </button>
                    <p class="text-[10px] text-[#666] text-center mt-3 uppercase tracking-widest">
                        Results are calculated using your custom replacement logic.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Result Modal -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden animate-in fade-in transition-all">
        <div class="bg-[#2f2f2f] w-full max-w-md rounded-3xl shadow-2xl border border-white/10 overflow-hidden animate-modal">
            <div class="flex justify-between items-center p-6 border-b border-white/10">
                <h2 class="text-xl font-semibold">Calculation Result</h2>
                <button onclick="closeModal()" class="text-[#666] hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-10 text-center">
                <div class="text-sm text-[#b4b4b4] mb-2 uppercase tracking-widest font-bold">Estimated Grade</div>
                <div id="final-grade-display" class="text-8xl font-black text-white mb-6 tracking-tighter drop-shadow-lg">--</div>
                
                <div class="bg-[#171717] rounded-2xl p-4 flex items-start gap-3 text-left">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-indigo-400 shrink-0 mt-0.5"></i>
                    <div class="text-sm">
                        <p class="text-white font-medium mb-1">Logic Applied</p>
                        <p id="logic-note" class="text-[#b4b4b4] leading-relaxed italic">--</p>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-[#212121]/50 border-t border-white/10 flex gap-3">
                <button onclick="closeModal()" class="flex-1 bg-white text-black py-3 rounded-xl font-bold hover:bg-[#ececec] transition">
                    Got it
                </button>
                <button onclick="resetData()" class="p-3 bg-rose-500/10 text-rose-400 rounded-xl hover:bg-rose-500/20 transition">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initial data structure
        let categories = [
            { id: 'final', name: 'Final Exam', weight: 40, items: [{ id: 1, score: '', max: 100 }], canDelete: false },
            { id: 'mid', name: 'Mid-term Exam', weight: 20, items: [{ id: 1, score: '', max: 100 }], canDelete: false },
            { id: 'projects', name: 'Projects', weight: 40, items: [{ id: 1, score: '', max: 100 }], canDelete: true }
        ];

        const appId = 'grade-calc-pro-persist';

        // Initial Load
        function loadData() {
            const saved = localStorage.getItem(appId);
            if (saved) categories = JSON.parse(saved);
            render();
            updateSidebar();
        }

        // Save data to LocalStorage
        function saveData() {
            localStorage.setItem(appId, JSON.stringify(categories));
        }

        // Clear all data
        function resetData() {
            if (confirm("This will clear all your saved scores. Continue?")) {
                localStorage.removeItem(appId);
                location.reload();
            }
        }

        // Render main content
        function render() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            categories.forEach((cat) => {
                const catDiv = document.createElement('div');
                catDiv.className = 'group animate-in fade-in slide-in-from-bottom-4 duration-500';
                catDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-4 border-b border-white/5 pb-2">
                        <div class="flex items-center gap-4">
                            <input type="text" value="${cat.name}" onchange="updateCatValue('${cat.id}', 'name', this.value)" 
                                class="bg-transparent border-none outline-none text-xl font-medium focus:ring-0 w-auto min-w-[120px] text-white">
                            <div class="flex items-center bg-[#2f2f2f] rounded-full px-3 py-1 gap-2 text-xs text-[#b4b4b4]">
                                <span>Weight:</span>
                                <input type="number" value="${cat.weight}" onchange="updateCatValue('${cat.id}', 'weight', this.value)"
                                    class="bg-transparent border-none w-10 p-0 text-center focus:ring-0 font-bold text-white">
                                <span>%</span>
                            </div>
                        </div>
                        ${cat.canDelete ? `
                            <button onclick="deleteCategory('${cat.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-rose-400 hover:bg-rose-500/10 rounded-full transition">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        ` : ''}
                    </div>
                    <div class="grid gap-3">
                        ${cat.items.map((item, idx) => `
                            <div class="flex items-center gap-4 bg-[#2f2f2f]/30 p-4 rounded-xl border border-transparent hover:border-white/10 transition">
                                <span class="text-xs text-[#666] font-mono">#${idx + 1}</span>
                                <div class="grid grid-cols-2 gap-6 flex-1">
                                    <div class="space-y-1">
                                        <span class="text-[10px] text-[#666] font-bold uppercase tracking-widest">Score</span>
                                        <input type="number" value="${item.score}" oninput="updateItemValue('${cat.id}', ${item.id}, 'score', this.value)"
                                            class="bg-[#2f2f2f] border-none rounded-lg w-full px-3 py-2 focus:ring-1 focus:ring-indigo-500 outline-none text-white">
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] text-[#666] font-bold uppercase tracking-widest">Max</span>
                                        <input type="number" value="${item.max}" oninput="updateItemValue('${cat.id}', ${item.id}, 'max', this.value)"
                                            class="bg-[#2f2f2f] border-none rounded-lg w-full px-3 py-2 focus:ring-1 focus:ring-indigo-500 outline-none text-white">
                                    </div>
                                </div>
                                ${cat.items.length > 1 ? `
                                    <button onclick="deleteItem('${cat.id}', ${item.id})" class="text-[#666] hover:text-rose-400 p-1">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                        <button onclick="addItem('${cat.id}')" class="flex items-center gap-2 text-sm text-[#b4b4b4] hover:text-white transition mt-2 w-fit px-2">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i> Add item
                        </button>
                    </div>
                `;
                container.appendChild(catDiv);
            });
            lucide.createIcons();
            updateSidebar();
        }

        // Data Update Functions
        function updateCatValue(id, key, val) {
            const cat = categories.find(c => c.id === id);
            if (cat) cat[key] = (key === 'weight' ? parseFloat(val) || 0 : val);
            saveData();
            if(key === 'name') updateSidebar();
        }

        function updateItemValue(catId, itemId, key, val) {
            const cat = categories.find(c => c.id === catId);
            const item = cat.items.find(i => i.id === itemId);
            if (item) item[key] = val;
            saveData();
        }

        function addCategory() {
            categories.push({
                id: 'cat_' + Date.now(),
                name: 'Assignments',
                weight: 0,
                items: [{ id: Date.now(), score: '', max: 100 }],
                canDelete: true
            });
            render();
            saveData();
        }

        function deleteCategory(id) {
            categories = categories.filter(c => c.id !== id);
            render();
            saveData();
        }

        function addItem(catId) {
            const cat = categories.find(c => c.id === catId);
            cat.items.push({ id: Date.now(), score: '', max: 100 });
            render();
            saveData();
        }

        function deleteItem(catId, itemId) {
            const cat = categories.find(c => c.id === catId);
            cat.items = cat.items.filter(i => i.id !== itemId);
            render();
            saveData();
        }

        function updateSidebar() {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = `<div class="text-[10px] text-[#666] font-bold px-3 pt-2 uppercase">Your Categories</div>`;
            categories.forEach(c => {
                list.innerHTML += `
                    <div class="flex items-center gap-3 px-3 py-2 text-sm rounded-lg hover:bg-[#2b2b2b] cursor-default transition">
                        <i data-lucide="message-square" class="w-4 h-4 text-[#666]"></i>
                        <span class="truncate">${c.name}</span>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // Calculation Logic (Follows C++ reference logic)
        function calculate() {
            const finalCat = categories.find(c => c.id === 'final');
            const fItem = finalCat.items[0];
            const F100 = (parseFloat(fItem.score) / parseFloat(fItem.max)) * 100;

            if (isNaN(F100)) return alert("Please enter a valid Final Exam score first.");

            // Mid-term Score (Replacement Logic)
            const midCat = categories.find(c => c.id === 'mid');
            let m_p100 = F100;
            if (midCat && midCat.items[0].score !== '') {
                const m_score = parseFloat(midCat.items[0].score);
                const m_max = parseFloat(midCat.items[0].max);
                m_p100 = Math.max((m_score / m_max) * 100, F100);
            }

            // Weighted Exam Score E100
            const E100 = 0.75 * F100 + 0.25 * m_p100;

            // Project/Assignment average P100 (Calculates all categories except Final and Mid)
            const otherCats = categories.filter(c => !['final', 'mid'].includes(c.id));
            let pSum = 0, pCount = 0;
            otherCats.forEach(c => {
                c.items.forEach(i => {
                    const s = parseFloat(i.score), m = parseFloat(i.max);
                    if (!isNaN(s) && !isNaN(m) && m !== 0) {
                        pSum += Math.max((s / m) * 100, F100);
                        pCount++;
                    }
                });
            });

            const P100 = pCount > 0 ? pSum / pCount : F100;

            let result = 0, note = "";
            if (E100 <= 40) {
                result = E100;
                note = "Final grade equals E100 because E100 ≤ 40.";
            } else if (E100 >= 60) {
                result = (2 * E100 / 3) + (P100 / 3);
                note = "Standard formula applied (E100 ≥ 60).";
            } else {
                result = ( -((E100 * E100) / 60) + 5 * E100 / 3 + (P100 * E100) / 60 - 2 * P100 / 3 );
                note = "Interpolation formula applied (40 < E100 < 60).";
            }

            // Rounding with floating point safety
            document.getElementById('final-grade-display').innerText = Math.round(result + 1e-12);
            document.getElementById('logic-note').innerText = note;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        window.onload = loadData;
    </script>
</body>
</html>